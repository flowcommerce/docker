#!/usr/bin/env ruby

# Ex:
#
# ./build-play 0.0.19 13
# builds flowdocker/play:0.0.19-java13
# aka flowdocker/play:latest-java13

require "./helpers.rb"

play_tag = ARGV.shift.to_s.strip
java_tag = ARGV.shift.to_s.strip
arch = ARGV.shift.to_s.strip

if play_tag == "" || java_tag == ""
  puts "Usage: ./build-play $(sem-info tag latest) <13 or 17> [arch]"
  puts "ERROR: Missing play tag or java tag."
  exit(1)
end

play_image_tag = "flowdocker/play:#{play_tag}-java#{java_tag}"
play_image_latest = "flowdocker/play:latest-java#{java_tag}"

# Build in a tmp directory to avoid adding anything unnecessary into
# the context.
tmp_dir = "/tmp/docker.play.#{Process.pid}"
begin
  run("ls")
  run("mkdir #{tmp_dir}")
  run("cp Dockerfile.play-#{java_tag} #{tmp_dir}/Dockerfile")

  Dir.chdir(tmp_dir) do
    run("curl -O https://cdn.flow.io/util/environment-provider/environment-provider-version.txt")
    run("curl -O https://cdn.flow.io/util/environment-provider/environment-provider.jar")
    if arch == ""
      run("docker build --network=host --pull --no-cache -t #{play_image_tag} .")
      run("docker tag #{play_image_tag} #{play_image_latest}")
      run("docker push #{play_image_tag}")
      run("docker push #{play_image_latest}")
    else
      run("docker buildx create --use --driver docker-container --driver-opt network=host")
      run("docker buildx build --platform=#{arch} --pull --push --no-cache --progress plain -t #{play_image_tag} .")
      run("docker buildx build --platform=#{arch} --pull --push --no-cache --progress plain -t #{play_image_latest} .")
    end
  end

ensure
  run("rm -rf #{tmp_dir}")
end

puts ""
puts "Completed build and push of #{play_image_tag}"
